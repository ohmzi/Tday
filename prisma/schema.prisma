datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
 
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}
 
model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  password      String?
  image         String?
  accounts      Account[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  Todos         Todo[]
  CompletedTodo CompletedTodo[]
  Note          Note[]
  File          File[]
  lists         List[]
  UserPreferences       UserPreferences[]
  maxStorage    Decimal             @default(1000000.0) //default 100 mb of storage
  usedStoraged  Decimal             @default(0.0)
  protectedSymmetricKey String?
  enableEncryption      Boolean     @default(true)
  timeZone  String?
  role      UserRole       @default(USER)
  approvalStatus ApprovalStatus @default(PENDING)
  approvedAt DateTime?
  approvedById String?
  approvedBy User? @relation("UserApprovalAdmin", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedUsers User[] @relation("UserApprovalAdmin")
}

enum UserRole {
  ADMIN
  USER
}

enum ApprovalStatus {
  APPROVED
  PENDING
}

enum SortBy{
  dtstart
  due
  duration
  priority
}

enum GroupBy{
  dtstart
  due
  duration
  priority
  rrule
  list @map("project")
}

enum Direction{
  Ascending
  Descending
}

model UserPreferences {
  id                String    @id @default(cuid())
  user              User      @relation(fields: [userID], references: [id])
  userID            String    @unique
  sortBy            SortBy?
  groupBy           GroupBy?
  direction         Direction?
}
 
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
 
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}
 
 
model VerificationToken { 
  identifier        String
  token             String
  expires           DateTime
 
  @@id([identifier, token])
}

enum Priority{
  Low
  Medium
  High
}
enum RepeatInterval{
    daily
    weekly
    monthly
    weekdays
}

model Todo {
  id                String    @id @default(cuid())
  title             String
  description       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userID], references: [id])
  userID            String
  pinned            Boolean   @default(false)
  order             Int       @default(autoincrement())
  priority          Priority  @default(Low)

  // RFC 5545 scheduling fields
  dtstart           DateTime  @default(now())
  due               DateTime
  exdates           DateTime[]
  durationMinutes   Int       @default(30)
  rrule             String?
  timeZone          String    @default("UTC")

  completed         Boolean   @default(false)
  instances         TodoInstance[]
  list              List?      @relation(fields: [listID], references: [id], onDelete: SetNull)
  listID            String?    @map("projectID")

  @@index([userID])
  @@index([listID])
  @@index([userID, listID])
  @@map("todos")
}

model TodoInstance {
  id                       String    @id @default(cuid())
  todoId                   String
  todo                     Todo      @relation(fields: [todoId], references: [id], onDelete: Cascade)

  recurId                  String
  instanceDate             DateTime

  overriddenTitle          String?
  overriddenDescription    String?
  overriddenPriority       Priority?
  overriddenDtstart        DateTime?
  overriddenDurationMinutes Int?
  overriddenDue            DateTime?

  completedAt              DateTime?

  @@unique([todoId, instanceDate])
  @@map("todo_instances")
}

model CompletedTodo{
  id            String          @id @default(cuid())
  originalTodoID  String
  title         String
  description   String?
  priority      Priority
  completedAt   DateTime        @default(now())
  dtstart     DateTime
  due     DateTime
  completedOnTime Boolean
  daysToComplete  Decimal @db.Decimal(10, 2)
  rrule  String?
  user          User            @relation(fields: [userID], references: [id])
  userID        String
  instanceDate  DateTime?
  listName      String? @map("projectName")
  listColor     String? @map("projectColor")

  @@index([userID])
}

model Note{
  id            String          @id @default(cuid())
  name          String
  content       String?
  createdAt     DateTime        @default(now())
  user          User            @relation(fields: [userID], references: [id])
  userID        String
}

enum ListColor {
  RED
  ORANGE
  YELLOW
  LIME
  BLUE
  PURPLE
  PINK
  TEAL
  CORAL
  GOLD
  DEEP_BLUE
  ROSE
  LIGHT_RED
  BRICK
  SLATE
  @@map("ProjectColor")
}

model List {
  id        String   @id @default(cuid())
  name      String
  color     ListColor?
  iconKey   String?
  user      User     @relation(fields: [userID], references: [id])
  userID    String
  todos     Todo[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([userID])
  @@map("Project")
}

model AuthThrottle {
  id            String    @id @default(cuid())
  scope         String
  bucketKey     String
  requestCount  Int       @default(0)
  failureCount  Int       @default(0)
  windowStart   DateTime  @default(now())
  lockUntil     DateTime?
  lastFailureAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([scope, bucketKey])
  @@index([scope, lockUntil])
}
 
model File{
  id            String          @id @default(cuid())
  name          String
  url           String
  size          Int
  createdAt     DateTime        @default(now())
  user          User            @relation(fields: [userID], references: [id])
  userID        String
  s3Key         String
}

model CronLog{
  id            String          @id @default(cuid())
  runAt         DateTime
  success       Boolean
  log           String
}

model eventLog{
    id          String          @id @default(cuid())
    capturedTime DateTime @default(now())
    eventName   String
    log         String
  }
